<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å Real-time</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #1d2b64 0%, #0c0c0c 100%);
            min-height: 100vh; padding: 20px; display: flex;
            justify-content: center; align-items: flex-start;
        }
        .main-container {
            display: flex; flex-wrap: wrap; gap: 25px;
            width: 100%; max-width: 1200px; /* Adjusted max-width for a single item */
            justify-content: center;
        }
        .lottery-instance {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .left-panel {
            flex: 1.2; min-width: 450px; background: white; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-radius: 8px;
            position: relative; overflow: hidden; height: fit-content;
        }
        .right-panel {
            flex: 1; min-width: 400px; display: flex;
            flex-direction: column; gap: 20px;
        }
        .product-display, .conditions-panel {
            background: white; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-radius: 8px;
        }
        .product-display img { width: 100%; height: auto; border-radius: 6px; margin-bottom: 15px; }
        .product-title { font-size: 24px; font-weight: 700; color: #1e1b4b; margin-bottom: 8px; }
        .product-description { font-size: 15px; color: #4b5563; line-height: 1.6; }
        .conditions-panel .panel-title { font-size: 18px; font-weight: 700; color: #1e1b4b; margin-bottom: 15px; border-bottom: 2px solid #6366f1; padding-bottom: 10px; }
        .result-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .result-input { flex: 1; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: center; font-family: 'Sarabun', sans-serif; }
        .result-input:focus { outline: none; border-color: #4f46e5; }
        .btn-check { background: #10b981; color: white; border: none; padding: 0 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s ease; }
        .btn-check:hover { background: #059669; }
        .result-message { background: #f3f4f6; border: 1px dashed #d1d5db; border-radius: 6px; padding: 15px; min-height: 100px; font-size: 15px; line-height: 1.7; color: #374151; }
        .header { text-align: center; margin-bottom: 15px; border-bottom: 3px solid #4f46e5; padding-bottom: 10px; }
        .title { font-size: 26px; font-weight: 700; color: #1e1b4b; }
        .subtitle { font-size: 14px; color: #6366f1; font-weight: 600; }
        .numbers-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; margin-bottom: 12px; }
        .number-card { aspect-ratio: 1; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: #374151; background: #f8fafc; cursor: pointer; transition: all 0.2s ease; }
        .number-card:hover:not(.assigned) { transform: scale(1.1); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); border-color: #6366f1; z-index: 10; }
        .number-card.selected { background: linear-gradient(145deg, #4f46e5, #7c3aed); color: white; border-color: #4338ca; transform: scale(0.95); }
        .number-card.assigned { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; border-color: #d1d5db; }
        .name-assignment { background: #f9fafb; border-radius: 6px; padding: 10px; margin-top: 10px; border: 1px solid #e5e7eb; }
        .selected-title { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .name-input-section { display: flex; gap: 8px; margin-bottom: 10px; }
        .name-input { flex: 1; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Sarabun', sans-serif; }
        .name-input:focus { outline: none; border-color: #4f46e5; }
        .btn-assign { background: #8b5cf6; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-assign:hover:not(:disabled) { background: #7c3aed; }
        .btn-assign:disabled { background: #9ca3af; cursor: not-allowed; }
        .assignments-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 6px; max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .assignment-item { background: white; border: 1px solid #e5e7eb; border-radius: 4px; padding: 8px; display: flex; justify-content: flex-start; align-items: center; gap: 10px; }
        .assignment-number { background: #4f46e5; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .assignment-name { font-weight: 600; color: #374151; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-random { background: #10b981; color: white; }
        .btn-export { background: #f59e0b; color: white; }
        .footer { text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb; }
        .instructions { font-size: 12px; color: #6b7280; line-height: 1.5; }

    </style>
</head>
<body>
    <div class="main-container">

        <!-- ============== LOTTERY INSTANCE ============== -->
        <div class="lottery-instance">
            <div class="left-panel">
                <div class="header">
                    <h1 class="title">üé≤ ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å üé≤</h1>
                    <p class="subtitle">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏∞ 150 ‡∏ö‡∏≤‡∏ó</p>
                </div>
                <div class="numbers-grid" id="numbersGrid"></div>
                <div class="name-assignment">
                    <div class="selected-title">üë§ ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô-‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô 5223-‡∏¢‡∏∑‡∏ô‡∏¢‡∏á (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</div>
                    <div class="name-input-section">
                        <input type="text" class="name-input" id="nameInput" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠..." maxlength="30">
                        <button class="btn-assign" id="assignBtn" disabled>üìù ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                    </div>
                    <div class="assignments-list" id="assignmentsList"></div>
                </div>
                <div class="controls">
                    <button class="btn btn-random" id="randomBtn">üéØ ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ß‡πà‡∏≤‡∏á</button>
                    <button class="btn btn-export" id="exportBtn">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                </div>
            </div>
            <div class="right-panel">
                <div class="product-display">
                    <img src="https://lh3.googleusercontent.com/d/1uJfh__1Uvqf-lOo7gSyujSMBMEPgMoli" alt="‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•">
                    <h2 class="product-title">üéÅ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ</h2>
                    <p class="product-description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
                </div>
                <div class="conditions-panel">
                    <h3 class="panel-title">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
                    <div class="result-input-group">
                        <input type="number" class="result-input" id="winningNumberInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å" min="0" max="99">
                        <button class="btn-check" id="checkBtn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•</button>
                    </div>
                    <div class="result-message" id="resultMessage">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziAiOR8LA54Ce2w02LeqTU6OdyE0eyK2udfMDr33k9Xnk5G_FP6Bg5v7xYQ1ea-wTn-w/exec";
        const GRID_ID = 'A'; // ‡∏£‡∏∞‡∏ö‡∏∏ ID ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
        // A A A A A A A A A A A A A A A A A A A A A A A A A A A A A A A A A
        // =================================================================

        // --- State Management ---
        const state = {
            selectedNumbers: new Set(),
            assignments: new Map(),
            isLoading: false,
            elements: {
                grid: document.getElementById('numbersGrid'),
                list: document.getElementById('assignmentsList'),
                input: document.getElementById('nameInput'),
                assignBtn: document.getElementById('assignBtn'),
                randomBtn: document.getElementById('randomBtn'),
                exportBtn: document.getElementById('exportBtn'),
                winInput: document.getElementById('winningNumberInput'),
                checkBtn: document.getElementById('checkBtn'),
                winMessage: document.getElementById('resultMessage')
            }
        };

        // --- Reusable Functions ---
        function renderNumberGrid() {
            const { grid } = state.elements;
            grid.innerHTML = '';
            for (let i = 0; i <= 99; i++) {
                const numberStr = String(i).padStart(2, '0');
                const numberCard = document.createElement('div');
                numberCard.className = 'number-card';
                numberCard.textContent = numberStr;
                if (state.assignments.has(numberStr)) {
                    numberCard.classList.add('assigned');
                } else {
                    if (state.selectedNumbers.has(numberStr)) numberCard.classList.add('selected');
                    numberCard.onclick = () => toggleNumber(numberStr);
                }
                grid.appendChild(numberCard);
            }
        }

        function updateAssignmentsDisplay() {
            const { list } = state.elements;
            if (state.assignments.size === 0) {
                list.innerHTML = '<span style="color: #9ca3af; font-style: italic;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...</span>';
                return;
            };
            const sorted = Array.from(state.assignments.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            list.innerHTML = sorted.map(([num, name]) => `
                <div class="assignment-item">
                    <span class="assignment-number">${num}</span>
                    <span class="assignment-name">${name}</span>
                </div>`).join('');
        }

        function updateUI() {
            renderNumberGrid();
            updateAssignmentsDisplay();
        }

        function toggleNumber(numberStr) {
            if (state.isLoading) return;
            if (state.selectedNumbers.has(numberStr)) {
                state.selectedNumbers.delete(numberStr);
            } else {
                state.selectedNumbers.add(numberStr);
            }
            renderNumberGrid();
            updateAssignButton();
        }

        function updateAssignButton() {
            const { input, assignBtn } = state.elements;
            assignBtn.disabled = !(state.selectedNumbers.size > 0 && input.value.trim().length > 0) || state.isLoading;
        }

        // --- Data Functions (API Calls) ---
        async function loadData() {
            if (state.isLoading) return;
            state.isLoading = true;
            updateAssignButton();
            try {
                const response = await fetch(`${SCRIPT_URL}?grid=${GRID_ID}`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const data = await response.json();
                state.assignments = new Map(data);
            } catch (error) {
                console.error('Failed to load data:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            } finally {
                state.isLoading = false;
                updateUI();
                updateAssignButton();
            }
        }

        async function assignName() {
            const { input, assignBtn } = state.elements;
            const name = input.value.trim();
            if (state.isLoading || !name || state.selectedNumbers.size === 0) return;

            state.isLoading = true;
            assignBtn.disabled = true;
            assignBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            
            const assignmentsToSend = Array.from(state.selectedNumbers).map(num => ({ number: num, name: name }));
            const postData = { grid: GRID_ID, assignments: assignmentsToSend };
            const formData = new FormData();
            formData.append('data', JSON.stringify(postData));

            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Failed to save data: ${response.statusText}`);
                const result = await response.json();
                console.log('Server response:', result);
                alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß!');
            } catch (error) {
                console.error('Failed to save data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }

            state.selectedNumbers.clear();
            input.value = '';
            assignBtn.textContent = "üìù ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
            state.isLoading = false;
            updateAssignButton();
            setTimeout(loadData, 2000);
        }

        // --- Specific Actions ---
        function randomSelect() {
            if(state.isLoading) return;
            
            const allNumbers = Array.from({length: 100}, (_, i) => String(i).padStart(2, '0'));
            const available = allNumbers.filter(num => !state.assignments.has(num));
            
            if (available.length === 0) {
                return alert('‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
            }
            
            const randomNum = available[Math.floor(Math.random() * available.length)];
            
            state.selectedNumbers.clear();
            state.selectedNumbers.add(randomNum);
            
            renderNumberGrid();
            updateAssignButton();
        }

        async function checkWinner() {
            const { winInput, winMessage } = state.elements;
            const numStr = winInput.value.trim().padStart(2, '0');

            if (!/^\d{1,2}$/.test(winInput.value.trim())) {
                winMessage.innerHTML = '<span style="color: red;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç (0-99)</span>';
                return;
            }
            
            await loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠

            if (!state.assignments.has(numStr)) {
                winMessage.innerHTML = `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç <b>${numStr}</b> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á`;
            } else {
                const winnerName = state.assignments.get(numStr);
                winMessage.innerHTML = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏∑‡∏≠ <b>${winnerName}</b> (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç <b>${numStr}</b>)`;
            }
        }
        
        function exportToExcel() {
            if (state.assignments.size === 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
            let csv = '\uFEFF‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç,‡∏ä‡∏∑‡πà‡∏≠\n';
            const sorted = Array.from(state.assignments.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            sorted.forEach(([num, name]) => { csv += `${num},"${name}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lottery_assignments_grid_${GRID_ID}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            const { elements } = state;
            updateUI();
            loadData();
            
            elements.input.addEventListener('input', updateAssignButton);
            elements.assignBtn.addEventListener('click', assignName);
            elements.randomBtn.addEventListener('click', randomSelect);
            elements.exportBtn.addEventListener('click', exportToExcel);
            elements.checkBtn.addEventListener('click', checkWinner);

            setInterval(loadData, 20000); // Poll every 20 seconds
        });
    </script>
</body>
</html>
